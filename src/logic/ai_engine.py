import os
import streamlit as st
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_core.prompts import PromptTemplate
from dotenv import load_dotenv

load_dotenv()

def get_api_key():
    key = os.getenv("GOOGLE_API_KEY")
    if not key and "GOOGLE_API_KEY" in st.secrets:
        key = st.secrets["GOOGLE_API_KEY"]
    return key

def get_llm():
    api_key = get_api_key()
    if not api_key:
        raise ValueError("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Google API Key! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô .env ‡∏´‡∏£‡∏∑‡∏≠ Secrets")
    
    return ChatGoogleGenerativeAI(
        model="gemini-2.5-flash", 
        google_api_key=api_key,
        temperature=0.3
    )

def extract_rules_from_pdf_text(raw_text):
    try:
        llm = get_llm()
        prompt_template = """
        ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö AI
        
        ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:
        1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        2. ‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î" (Do's & Don'ts)
        3. ‡∏ï‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏ó‡∏∏‡πà‡∏á‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÜ
        4. ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏ß‡∏¢ "--------------------" (‡∏Ç‡∏µ‡∏î‡∏Å‡∏•‡∏≤‡∏á 20 ‡∏ó‡∏µ) ‡πÄ‡∏™‡∏°‡∏≠
        
        ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö:
        {text}
        
        ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Format: ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1 ... \n--------------------\n ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 ...):
        """
        prompt = PromptTemplate(template=prompt_template, input_variables=["text"])
        chain = prompt | llm
        return chain.invoke({"text": raw_text}).content
    except Exception as e:
        return f"Error extracting rules: {e}"

def generate_course_design(job_title, duration, objectives, context, retrieved_rules):
    try:
        llm = get_llm()
        
        design_prompt = """
        ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "DSD Course Architect" ‡∏ô‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ù‡∏µ‡∏°‡∏∑‡∏≠‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô
        
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏à‡∏ó‡∏¢‡πå:
        - ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: {job_title}
        - ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: {duration}
        - ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å: {objectives}
        - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {context}
        
        üìö ‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:
        "{rules}"
        
        ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:
        ‡∏à‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        
        ‚è∞ ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Time Constraints):
        1. **1 ‡∏ß‡∏±‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏° 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÄ‡∏ï‡πá‡∏°** (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏û‡∏±‡∏Å)
        2. **‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô** ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤):
           - 09:00 - 10:30 (1.5 ‡∏ä‡∏°.)
           - 10:30 - 10:45 (‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏ä‡πâ‡∏≤ 15 ‡∏ô‡∏≤‡∏ó‡∏µ)
           - 10:45 - 12:15 (1.5 ‡∏ä‡∏°.)
           - 12:15 - 13:15 (‡∏û‡∏±‡∏Å‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
           - 13:15 - 14:45 (1.5 ‡∏ä‡∏°.)
           - 14:45 - 15:00 (‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Å‡∏ö‡πà‡∏≤‡∏¢ 15 ‡∏ô‡∏≤‡∏ó‡∏µ)
           - 15:00 - 16:30 (1.5 ‡∏ä‡∏°.)
        3. ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤
        
        ‚ö†Ô∏è ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Content Rules):
        1. **‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ (‡∏ó‡∏§‡∏©‡∏é‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ (‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥) ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏™‡∏°‡∏≠** ‡πÄ‡∏ä‡πà‡∏ô "[‡∏ó‡∏§‡∏©‡∏é‡∏µ] ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "[‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥] ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏≤‡∏¢‡πÑ‡∏ü"
        2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Markdown 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡πÄ‡∏ß‡∏•‡∏≤ | ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏£‡∏∞‡∏ö‡∏∏ ‡∏ó‡∏§‡∏©‡∏é‡∏µ/‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥) | ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å | ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô/‡∏Å‡∏é‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
        3. ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (No Merged Cells) ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤
        4. ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î)
        
        ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (Response Format) - ‡πÉ‡∏ä‡πâ Markdown ‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πä‡∏∞‡πÜ:
        
        # ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: [‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£]

        ## 1. ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
        [‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...]

        ## 2. ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå
        * [‡∏Ç‡πâ‡∏≠ 1]
        * [‡∏Ç‡πâ‡∏≠ 2]

        ## 3. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        * {job_title}

        ## 4. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏° (Schedule)
        
        | ‡πÄ‡∏ß‡∏•‡∏≤ | ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ | ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å | ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô/‡∏Å‡∏é‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á |
        | :--- | :--- | :--- | :--- |
        | 09:00 - 10:30 | **[‡∏ó‡∏§‡∏©‡∏é‡∏µ]** [‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤] | [‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î] | [‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏é] |
        | 10:30 - 10:45 | **‡∏û‡∏±‡∏Å‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á** | - | - |
        | 10:45 - 12:15 | **[‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥]** [‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤] | [‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î] | [‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏é] |
        | 12:15 - 13:15 | **‡∏û‡∏±‡∏Å‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô** | - | - |
        | 13:15 - 14:45 | **[‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥]** [‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤] | [‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î] | [‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏é] |
        | 14:45 - 15:00 | **‡∏û‡∏±‡∏Å‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á** | - | - |
        | 15:00 - 16:30 | **[‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥]** [‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤] | [‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î] | [‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏é] |
        
        ## 5. ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•
        * [‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...]

        ## 6. ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö
        * [‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...]
        """
        
        prompt = PromptTemplate(template=design_prompt, input_variables=["job_title", "duration", "objectives", "context", "rules"])
        chain = prompt | llm
        return chain.invoke({
            "job_title": job_title, 
            "duration": duration, 
            "objectives": objectives, 
            "context": context, 
            "rules": retrieved_rules
        }).content
    except Exception as e:
        return f"Error designing course: {e}"